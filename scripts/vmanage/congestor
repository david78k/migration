# make congestion at specified times in seconds
# intervals in seconds
# repeat some pattern until there are no VMs to migrate
#times=( 2 2 2 )
#times=( 30 30 30 30 30 30)
times=( 50 50 50 )
#times=( 100 100 100 )

# delays in ms
#delays=( 180 80 20 )
delays=( 20 80 180 )
#delays=( 20 80 180 180 80 20 )

# loss rates in %
losses=( 0 0 0 0 0 0 )

wanem=c11node28

total=0

rvms=`virsh list --all | grep running | wc -l`
#tvms0=`virsh list --all | grep running | wc -l`

while [ $rvms -gt 0 ]; do
	for (( i = 0 ; i < ${#delays[@]} ; i++ )); do
		echo $rvms

		delay=`expr ${delays[$i]} / 2`

		echo ${total}sec, ${times[$i]}sec, ${delay}ms, ${losses[$i]}%
		#echo ${total}sec, ${times[$i]}sec, ${delays[$i]}ms, ${losses[$i]}%

		ssh $wanem service tc loss ${delay} ${losses[$i]}

		sleep ${times[$i]}
		total=`expr $total + ${times[$i]}`

		rvms=`virsh list --all | grep running | wc -l`
		if [ $rvms -eq 0 ]; then
			break
		fi
	done
done

ssh $wanem service tc stop

# total migration time


#total vms migrated
#tvms=`virsh list --all | grep running | wc -l`
#echo $tvms
#mvms=`expr $tvms0 - $tvms`
#echo total $mvms
