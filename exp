#!/bin/bash

################################################################
#
#                  parameter configuration  
#
################################################################

#bench=memtouch
bench=kernelcompile
#ram=128
#ram=256
ram=1024
vcpu=1
# max link speed 118MB/s or 1000Mb/s
speed=125 # migrate speed in MB/s
mode=precopy
# capability
cap=xbzrle 
#cap=none 
xbzrle=off # on/off

expno=1

# kernel compile
warmup=20 # time in seconds to make clean and warm up

# sysbench params
#prefix=1024_RO_${expno}

# memtouch params
#warmup=10
dirtyrate=100 # MB/s
#prefix=s${speed}_r${ram}_d${dirtyrate}_n${expno}

loghome=log

# for cpu utilization
PREV_TOTAL=0
PREV_IDLE=0

################################################################
#
#                       functions  
#
################################################################

function cpusage() {
  CPU=(`grep '^cpu ' /proc/stat`) # Get the total CPU statistics.
  unset CPU[0]                          # Discard the "cpu" prefix.
  IDLE=${CPU[4]}                        # Get the idle CPU time.
  # Calculate the total CPU time.
  TOTAL=0
  for VALUE in "${CPU[@]}"; do
    let "TOTAL=$TOTAL+$VALUE"
  done

  # Calculate the CPU usage since we last checked.
  let "DIFF_IDLE=$IDLE-$PREV_IDLE"
  let "DIFF_TOTAL=$TOTAL-$PREV_TOTAL"
  let "DIFF_USAGE=(1000*($DIFF_TOTAL-$DIFF_IDLE)/$DIFF_TOTAL+5)/10"
  echo -e "\rCPU: $DIFF_USAGE %  \b\b"

  # Remember the total and idle CPU times for the next check.
  PREV_TOTAL="$TOTAL"
  PREV_IDLE="$IDLE"
}

#######################################################################################

function ncmigrate() {
nc localhost 4446 << EOF
info status
info version
info kvm
migrate_set_capability xbzrle $xbzrle
info migrate_capabilities
migrate_set_speed $speed
migrate tcp:c11node10:4444
info migrate
info status
quit
EOF
echo
}

#######################################################################################

function migrate() {
cap=$1

if [ $cap == "xbzrle" ]; then
	xbzrle=on
fi

prefix=$expno
if [ $bench == "memtouch" ]; then
	prefix=dirty${dirtyrate}_${expno}
fi

logdir=$loghome/${bench}/${mode}/ram${ram}/vcpu${vcpu}/speed${speed}/${cap}
#logdir=$loghome/${bench}/${mode}/${cap}/ram${ram}/vcpu${vcpu}/speed${speed}
#logdir=$loghome/${bench}/${mode}/${cap}/ram${ram}/vcpu${vcpu}/speed${speed}/dirty${dirtyrate}
logfile=$logdir/${prefix}.log
dstatfile=$logdir/${prefix}.dstat
migfile=$logdir/${prefix}.mig # nc migration results

mkdir -p $logdir 

echo ram = $ram MB
echo migration speed = $speed MB/s
echo benchmark = $bench
echo dirty rate = $dirtyrate MB/s
echo xbzrle = $xbzrle
echo

#echo sb_${prefix}.log
echo $logfile
echo

dest=c11node10
telnetport=4446
vmargs="$ram $vcpu"

echo "$dest (${ram}MB) listening ..."
ssh $dest /root/qemu/listen-daemon $vmargs
#ssh $dest /root/qemu/listen-postcopy-daemon $ram

#sleep 3

./runvm-daemon $vmargs
#./runvm-daemon $ram

echo waiting 20 seconds for VM bootup ...
sleep 20

echo starting dstat ...
#ssh localhost -p 5555 "dstat -cmdngy --noheaders > dstat/${prefix}.log" &
dstat -cmdngy --noheaders > $dstatfile &

# run benchmark (memtouch, sysbench, apache, netperf, lmbench, kc) in background
bencharg=
if [ $bench == "memtouch" -a $dirtyrate -ne 0 ]; then
	bencharg=$dirtyrate
	#ssh localhost -p 5555 "/root/run-memtouch $dirtyrate" &
fi

sshcmd="/root/run-${bench} $bencharg"

echo starting $bench $bencharg ...
#echo starting memtouch $dirtyrate ...
ssh localhost -p 5555 "$sshcmd" &

#echo starting sysbench ...
#ssh localhost -p 5555 "/root/run > sysbench/${prefix}.log" &

echo waiting $warmup seconds for initializing ...
sleep $warmup
echo

echo starting migration ...

cpusage

#./ncmigrate-postcopy > log/mt_${prefix}.log
ncmigrate > $migfile
#logsave $migfile ncmigrate

cpusage >> $migfile

egrep -a "time|transferred|bytes|pages|mbps|cache|overflow|CPU" $migfile > $logfile
cat $logfile

echo waiting 10 seconds for finalizing ...
sleep 10

# shutdown VM at dest
./stopvm $dest $telnetport

# stop dstat
pgrep -fl dstat| awk '{print $1}' | xargs kill -9
}

################################################################
#
#                       iterations  
#
################################################################

#rams=( 256 512 1024 2048 4096 )
rams=( 1024 )
#caps=( default xbzrle auto-converge xbzrle+auto-converge )
caps=( default xbzrle )
#caps=( default )
#caps=( xbzrle )
#speeds=( 50 60 70 80 90 100 110 120 )
speeds=( 125 )
runs=( 10 )
#runs=( 4 5 6 7 8 9 10 )

################# benchmark specific params ###################
# memtouch
dirtyrates=( 10 20 30 40 50 60 70 80 90 100 110 120 )
#dirtyrates=( 0 )
# kernel compile
vcpus=( 1 2 4 8 12 )
#vcpus=( 2 8 12 )

for run in ${runs[@]}
do
	expno=$run
for mem in ${rams[@]}
do
	ram=$mem
for sp in ${speeds[@]}
do
	speed=$sp
	for cap in ${caps[@]}
	do
		if [ $bench == "memtouch" ]; then
			for rate in ${dirtyrates[@]}
			do
				dirtyrate=$rate
				migrate	$cap $rate
			done
		elif [ $bench == "kernelcompile" ]; then
			for arg in ${vcpus[@]}
			do
				vcpu=$arg
				#echo migrate $cap $arg
				echo migrate $cap $vcpu
				migrate	$cap 
			done
		fi
	done
done
done
done

